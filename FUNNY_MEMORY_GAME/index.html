<!DOCTYPE html>
<html>
<head>
    <title>Funny Memory Game</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style/main.css">

    <script defer src="script/dom.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script defer src="script/classes.js"></script>
</head>

<body>
<div class="wrapper" id="wrapper_main">
<h1 class="logo" onclick="switchToMainPage()">Funny Memory <span>Game</span></h1>
<div id="start_page" class="start_page">
   <div class="wrapper_button">
       <button tabindex="1" id="btn_begin_play" onclick="switchToGamePage()">Start play</button>
      <button tabindex="1" id="btn_records" onclick="switchToRecordsPage()">The best players</button>
       <button  tabindex="1" id="btn_description" onclick="switchToDescriptionPage()">About game</button>
   </div> 
<img class="main_pencil" src="images/pencil.svg">
</div>
</div>

<script>

var SPAState={};
  
  function switchToStateFromURLHash() {

    var URLHash=window.location.hash;
    var stateStr=URLHash.substr(1);
    if ( stateStr!="" ) // если закладка непустая, читаем из неё состояние и отображаем
    {
      SPAState={ pagename: stateStr }; // первая часть закладки - номер страницы
    }
    else
      SPAState={pagename:'Main'}; // иначе показываем главную страницу

    var pageHTML="";
    switch ( SPAState.pagename ) {
      case 'Main':
        pageHTML+='<div class="wrapper_button"><button tabindex="1" id="btn_begin_play" onclick="switchToGamePage()">Start play</button><button tabindex="1" id="btn_records" onclick="switchToRecordsPage()">The best players</button><button  tabindex="1" id="btn_description" onclick="switchToDescriptionPage()">About game</button></div> <img class="main_pencil"src="images/pencil.svg">';
        break;
      case 'Play':
        pageHTML+='<div id="containerInfoGame"><div id="play" class="start_page"><div id="playerInfo"><h3>Information about you</h3><label for="namePlayer">Your Name <input type="text" value ='+window.localStorage["UserName"]+' tabindex="-1" autofocus name="namePlayer" id="namePlayer"></label><div id="playersBestScore">Your Best Score <span></span></div></div><div id="choise_back"><h3>Cards Back</h3><label for="family"><input  type="radio" name="back" id="family" value="family" checked><img src="images/sprite_back2.svg#family"></label><label for="animals"><input type="radio"  name="back" id="animals" value="animals"><img src="images/sprite_back2.svg#animals"></label><label for="numbers"><input type="radio" name="back" id="numbers" value="numbers"><img src="images/sprite_back2.svg#numbers"></label></div><div id="choice_difficult"><h3>Difficulty Of The Game</h3><input type="radio"  name="difficulty" value="6" id="easy" ><label  for="easy">Easy (6)</label><input type="radio"  name="difficulty" value="12" id="medium" checked><label for="medium">Medium (12)</label><input  type="radio" name="difficulty" value="18" id="hard"><label for="hard">Hard (18)</label></div></div><button id="btn_play" onclick="startPlay()">PLAY</button><div id="timerStepsReset"><div id="steps">Steps <p><span id="numbersOfSteps"></span></p></div><div id="timer">Timer <p><span id="min"></span><span id="sec"></span></p></div></div><div id="board_cards"></div><div id="congratulations"></div></div>';
        
        break;
      case 'Records':
			pageHTML+="<div id='wrap_records'>Records</div>";
				pageHTML+="<table id='table_records'>";
					pageHTML+="<tr><td>User</td><td>Score</td><td>Steps</td></tr>";
					var lastRecords=[];
          for (let i = 0; i < lastRecords.length; i++){
            pageHTML+="<tr><td>"+(i+1)+"</td><td>"+lastRecords[i]["userName"]+"</td><td>"+lastRecords[i]["score"]+"</td></tr>";
          }
        pageHTML+="</table>";
        break;
      case 'Description':
        pageHTML+='<div id="description" class="start_page"><p class="description_game"><img class="butterfly but1" src="images/butterfly.png"><img class="butterfly but2"src="images/butterfly.png"><img class="butterfly but3"src="images/butterfly.png"><img class="butterfly but4"src="images/butterfly.png">Наше приложение разработано специально для детишек в возрасте от двух лет. Игра позволяет тренировать память, запоминать новые слова. Выбирая рубашку карт, вы определяете и рубрику тем карточек-перевертышей. Постепенно натренировав свою память, можно также и увеличивать уровень сложности. Управление игрой осуществляется либо мышкой, либо стрелками &laquo;вверх&raquo;, &laquo;вниз&raquo;, &laquo;вперед&raquo;, &laquo;назад&raquo; и &laquo;enter&raquo;. </p></div>';
         break;
    }
    document.getElementById('start_page').innerHTML=pageHTML;
  }
function userName(){
  if (window.localStorage["UserName"]==undefined){
    window.localStorage["UserName"]="User";
  }
 
}
userName();
  function switchToState(newState) {
    var stateStr=newState.pagename;
    location.hash=stateStr;
  }

  function switchToMainPage() {
    switchToState( { pagename:'Main' } );
  }

  function switchToGamePage() {
    switchToState( { pagename:'Play'} );
  }
  
  function switchToRecordsPage() {
    switchToState( { pagename:'Records' } );
  }

  function switchToDescriptionPage() {
    switchToState( { pagename:'Description' } );
  }

  window.addEventListener('hashchange', switchToStateFromURLHash, false);
  switchToStateFromURLHash();



</script>
<script>

	var stringName='SHUST_MEMORY_GAME';
	var ajaxHandlerScript="https://fe.it-academy.by/AjaxStringStorage2.php";
var updatePassword;
	var recordsLength = 10;
	var lastRecords = [];
	var context = null;
	var userName;
var score;
var steps;
	
	restoreInfo();
	
	function restoreInfo() {
			$.ajax(
					{
							url : ajaxHandlerScript, type : 'POST', cache : false, dataType:'json',
							data : { f : 'READ', n : stringName },
							success : readReady, error : errorHandler,
					}
			);
	}
	
	
	function readReady(callresult) {
			if ( callresult.error!=undefined )
					 alert(callresult.error);
			 else if ( callresult.result!="" ) {
					 lastRecords=JSON.parse(callresult.result);
					 console.log(lastRecords);
			}
	}
	
	function storeInfo(self) {
			score = parseFloat(window.localStorage["TimeSec"]);
			updatePassword=Math.random();
			$.ajax( {
							url : ajaxHandlerScript, type : 'POST', cache : false, dataType:'json',
							data : { f : 'LOCKGET', n : stringName, p : updatePassword },
							success : lockGetReady, error : errorHandler
					}
			);
	}
	
	function lockGetReady(callresult) {
			if ( callresult.error!=undefined )
					alert(callresult.error);
			else {
					
				if (lastRecords.some(isRecordMax) || lastRecords.length < 10){
					console.log(lastRecords.some(isRecordMax));

				}
				 else {
							return;
						}
			}
	}
	
	function updateReady(callresult) {
			if ( callresult.error!=undefined )
					alert(callresult.error);
	}
	
	function errorHandler(jqXHR,statusStr,errorStr) {
			alert(statusStr+' '+errorStr);
	}
	
	let isRecordMax = (V, I, A) => {return points > V["point"]};                //функция-стрелка проверки попадает ли рекорд в топ 10
	
	
	function recordOfPoints(score, arrOfPoints) {                                         // функция записи рекорда
			userName = window.localStorage["UserName"];
			if (arrOfPoints.some(isRecordMax)){
				for (let i = 0; i <arrOfPoints.length; i++){
					 if (score > arrOfPoints[i]["score"]){
						 let arrOfRec = arrOfPoints.splice(i, (arrOfPoints.length - i));                  // вариант через методы массива
						 arrOfPoints[i] = {name : userName, score : score};
						 arrOfPoints = arrOfPoints.concat(arrOfRec);
						 if (arrOfPoints.length > 10){
							 arrOfPoints.pop();
						 }
						 break;
					 }
				 }
			 }
			else {
				arrOfPoints.push({name : userName, score : score});
			}
		
			updateAJAX(arrOfPoints);
			return lastRecords = arrOfPoints;
		}
	
	function updateAJAX(lastRecords){
		$.ajax( {
						url : ajaxHandlerScript, type : 'POST', cache : false, dataType:'json',
						data : { f : 'UPDATE', n : stringName, v : JSON.stringify(lastRecords), p : updatePassword },
						success : updateReady, error : errorHandler
				}
		);
	}
	

	
</script>
</body>

</html>